<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Live Alpaca Portfolio Dashboard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 2rem auto;
    padding: 0 1rem;
    background: #f9fafb;
    color: #111827;
  }
  h1, h2 {
    color: #1e3a8a;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  th, td {
    text-align: left;
    padding: 8px 12px;
    border-bottom: 1px solid #ddd;
  }
  th {
    background: #e0e7ff;
  }
  .chart-container {
    margin: 2rem 0;
    height: 300px;
  }
  .returns-table {
    margin-top: 1rem;
    width: 50%;
  }
</style>
</head>
<body>

<h1>Niko's 100k Fundamental Portfolio</h1>
<p>Live Alpaca data from your paper trading account.</p>

<h2>Live Portfolio Equity: <span id="liveEquity">Loading...</span></h2>
<h2>Portfolio Beta: <span id="portfolioBeta">Loading...</span></h2>

<h2>P&L Over Time</h2>
<canvas id="pnlChart" width="900" height="300"></canvas>

<h2>Returns (%)</h2>
<table class="returns-table" aria-label="Returns Table">
  <thead>
    <tr>
      <th>Period</th>
      <th>Return (%)</th>
    </tr>
  </thead>
  <tbody id="returnsBody">
    <tr><td>1 Day</td><td id="return-1d">Loading...</td></tr>
    <tr><td>1 Month</td><td id="return-1m">Loading...</td></tr>
    <tr><td>3 Months</td><td id="return-3m">Loading...</td></tr>
    <tr><td>6 Months</td><td id="return-6m">Loading...</td></tr>
    <tr><td>1 Year</td><td id="return-1y">Loading...</td></tr>
  </tbody>
</table>

<h2>Trade Log</h2>
<table id="tradeTable" aria-label="Trade Log Table">
  <thead>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th>Side</th>
      <th>Quantity</th>
      <th>Price</th>
      <th>Beta</th>
      <th>Execution ID</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function fetchData() {
  try {
    const betaRes = await fetch('/portfolio_beta');
    const betaData = await betaRes.json();
    document.getElementById('portfolioBeta').textContent = betaData.portfolio_beta;

    const balRes = await fetch('/account_balance');
    const balData = await balRes.json();
    document.getElementById('liveEquity').textContent = `$${balData.equity.toFixed(2)}`;

    const returnsRes = await fetch('/returns');
    const returnsData = await returnsRes.json();
    ['1d', '1m', '3m', '6m', '1y'].forEach(period => {
      const el = document.getElementById(`return-${period}`);
      if (returnsData[period] === null || returnsData[period] === undefined) {
        el.textContent = 'N/A';
      } else {
        el.textContent = returnsData[period].toFixed(2) + '%';
        el.style.color = returnsData[period] >= 0 ? 'green' : 'red';
      }
    });

    const pnlRes = await fetch('/pnl');
    const tradesRes = await fetch('/trades');
    const pnlData = await pnlRes.json();
    const trades = await tradesRes.json();

    const ctx = document.getElementById('pnlChart').getContext('2d');
    const labels = pnlData.map(p => p.date);
    const data = pnlData.map(p => p.pnl.toFixed(2));

    if (window.pnlChartInstance) {
      window.pnlChartInstance.destroy();
    }

    window.pnlChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Cumulative P&L',
          data: data,
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37, 99, 235, 0.2)',
          fill: true,
          tension: 0.3,
        }]
      },
      options: {
        responsive: false,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    const tbody = document.querySelector('#tradeTable tbody');
    tbody.innerHTML = '';
    trades.forEach(t => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${t.date}</td>
        <td>${t.symbol}</td>
        <td>${t.side}</td>
        <td>${t.qty}</td>
        <td>$${Number(t.price).toFixed(2)}</td>
        <td>${Number(t.beta).toFixed(2)}</td>
        <td style="font-size: 0.8em; color: #666;">${t.id}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error("Error fetching data:", err);
  }
}

fetchData();
setInterval(fetchData, 10000);
</script>
</body>
</html>

</body>
</html>
